name: PureStack SAP Audit

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  abap-quality-gate:
    runs-on: ubuntu-latest
    name: ğŸ’ ABAP Quality Gate

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ” Phase 1 Structural Integrity
        run: |
          echo "::group::File Structure Validation"
          if [ ! -f "src/zcl_ps_refactor.clas.abap" ]; then echo "âŒ Missing: Class implementation file"; exit 1; fi
          if [ ! -f "src/zcl_ps_refactor.clas.xml" ]; then echo "âŒ Missing: Class Metadata file (.xml)"; exit 1; fi
          if [ ! -f "abaplint.json" ]; then echo "âŒ Missing: Linter Configuration (abaplint.json)"; exit 1; fi
          echo "âœ… ABAP Git Structure is valid."
          echo "::endgroup::"

      - name: ğŸ•µï¸ Phase 2 Archaic Syntax Detection
        run: |
          echo "::group::Modern ABAP Check"
          # Ban 'CALL METHOD'
          if grep -i "CALL METHOD" src/zcl_ps_refactor.clas.abap; then echo "âŒ CRITICAL: 'CALL METHOD' detected. Use functional style."; exit 1; fi
          # Ban 'MOVE' (excluding MOVE-CORRESPONDING)
          if grep -i "MOVE " src/zcl_ps_refactor.clas.abap | grep -v "MOVE-CORRESPONDING"; then echo "âŒ CRITICAL: 'MOVE' detected. Use '='."; exit 1; fi
          # Ban 'COMPUTE'
          if grep -i "COMPUTE " src/zcl_ps_refactor.clas.abap; then echo "âŒ CRITICAL: 'COMPUTE' detected. Use '='."; exit 1; fi
          echo "âœ… No Archaic statements found."
          echo "::endgroup::"

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install abaplint
        run: npm install @abaplint/cli -g

      - name: ğŸ§ª Phase 3 Static Analysis
        run: abaplint
